"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),http=require("http"),Tester=function(){function t(e){(0,_classCallCheck2.default)(this,t),this.env=e,this.suites=[],this.storage={},this.declareSuites&&(this.suites=this.declareSuites())}var e;return(0,_createClass2.default)(t,[{key:"run",value:(e=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function e(){var t,s,n,r,o,i,u,a,l,c,h,p,f;return _regenerator.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:console.log("\n"),console.log("Starting API tests"),console.log("\n\n"),t=0;case 4:if(!(t<this.suites.length)){e.next=28;break}console.log("[36m"+this.suites[t].method.toUpperCase()+" "+this.suites[t].path+"[0m"),console.log("[2m"+this.suites[t].tests.length+" tests[0m"),console.log("\n"),s=0;case 9:if(s<this.suites[t].tests.length)return console.log(this.suites[t].tests[s].description),console.log("- - - - - - - - - - - - - - - - - - -"),e.next=14,this.call(this.suites[t].method,this.suites[t].path,this.suites[t].tests[s].body);e.next=23;break;case 14:n=e.sent,r=void 0,r=n.err?(console.log(" ",n.err),n.err):(console.log(" ",n.result),n.result),!0===(o=this.suites[t].tests[s].checker(r))?(this.suites[t].tests[s].passed=!0,console.log("[32m  PASSED[0m")):!1===o?(this.suites[t].tests[s].passed=!1,console.log("[31m  FAILED[0m")):console.log("[33m  INCONCLUSIVE[0m"),console.log("\n");case 20:s++,e.next=9;break;case 23:console.log("\n");case 25:t++,e.next=4;break;case 28:i=this.suites.map(function(e){return e.tests.length}),u=this.suites.map(function(e){return e.tests.filter(function(e){return!0===e.passed}).length}),a=this.sum(i),l=this.suites.length,c=this.sum(u),h=this.sum(u.map(function(e,t){return e===i[t]?1:0})),p=c===a?"[32m":"[31m",f=h===l?"[32m":"[31m",console.log("API tests complete"),console.log(f+h+"[0m out of "+l+" suites passed"),console.log(p+c+"[0m out of "+a+" tests passed"),console.log("\n");case 41:case"end":return e.stop()}},e,this)})),function(){return e.apply(this,arguments)})},{key:"call",value:function(n,r,o){var i=this;return new Promise(function(s,e){console.log("[2m ",o,"[0m");var t=http.request({host:i.env.host,port:i.env.port,path:i.env.path_root+r,method:n,headers:{"Content-Type":"application/json;charset=UTF-8"}},function(e){var t="";e.on("data",function(e){t+=e}),e.on("end",function(){try{var e=JSON.parse(t);s(e)}catch(e){s({err:t,result:null})}})});t.write(JSON.stringify(Object.assign({},o,{token:i.storage.token}))),t.end()})}},{key:"sum",value:function(e){return e.reduce(function(e,t){return e+t},0)}}]),t}(),Suite=function e(t,s,n){(0,_classCallCheck2.default)(this,e),this.method=t,this.path=s,this.tests=n};function when(s){return{with:function(t){return{check:function(e){return{description:s,body:t,checker:e,passed:null}}}}}}function match(t,e){return void 0===e.find(function(e){return void 0===t[e]})}var Mionendas={Tester:Tester,Suite:Suite,when:when,match:match};module.exports=Mionendas;