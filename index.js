"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_typeof2=_interopRequireDefault(require("@babel/runtime/helpers/typeof")),_possibleConstructorReturn2=_interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn")),_getPrototypeOf2=_interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf")),_inherits2=_interopRequireDefault(require("@babel/runtime/helpers/inherits")),_wrapNativeSuper2=_interopRequireDefault(require("@babel/runtime/helpers/wrapNativeSuper")),_regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),http=require("http"),Tester=function(){function t(e){(0,_classCallCheck2.default)(this,t),this.env=e,this.suites=[],this.storage={},this.declareSuites&&(this.suites=this.declareSuites())}var e;return(0,_createClass2.default)(t,[{key:"run",value:(e=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function e(){var t,s,r,n,o,a,i,u,l,c,h,f,p,m,d,g=this;return _regenerator.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:console.log("\n"),console.log("Starting API tests"),console.log("\n\n"),t=0;case 4:if(!(t<this.suites.length)){e.next=39;break}console.log("[36m"+this.suites[t].method.toUpperCase()+" "+this.suites[t].path+"[0m"),console.log("[2m"+this.suites[t].tests.length+" test"+this.plural(this.suites[t].tests.length)+" [0m"),console.log("\n"),s=0;case 9:if(!(s<this.suites[t].tests.length)){e.next=34;break}console.log("[35m"+this.suites[t].tests[s].description+"[0m"),console.log("- - - - - - - - - - - - - - - - - - -"),this.suites[t].tests[s].data=this.suites[t].tests[s].data_getter(),!1===Array.isArray(this.suites[t].tests[s].data)&&(this.suites[t].tests[s].data=[this.suites[t].tests[s].data]),this.suites[t].tests[s].passed=[],this.suites[t].tests[s].errors=[],r=0;case 17:if(r<this.suites[t].tests[s].data.length)return e.next=20,this.call(this.suites[t].method,this.suites[t].path,this.suites[t].tests[s].data[r]);e.next=30;break;case 20:n=e.sent,o=void 0,o=n.err?(console.log(" ",n.err),n.err):(console.log(" ",n.result),n.result),i=a=null;try{a=this.suites[t].tests[s].checker(o,r)}catch(e){e instanceof MatchError&&(a=!1),i=e}!0===a?(this.suites[t].tests[s].passed[r]=!0,console.log("[32m  PASSED\n[0m")):!1===a?(this.suites[t].tests[s].passed[r]=!1,this.suites[t].tests[s].errors[r]=i,console.log("[31m  FAILED[0m"+this.format_error(i)+"\n")):(this.suites[t].tests[s].passed[r]=null,this.suites[t].tests[s].errors[r]=i,console.log("[33m  INCONCLUSIVE[0m"+this.format_error(i)+"\n"));case 27:r++,e.next=17;break;case 30:console.log("");case 31:s++,e.next=9;break;case 34:console.log("\n\n\n");case 36:t++,e.next=4;break;case 39:u=this.suites.map(function(e){return g.sum(e.tests.map(function(e){return e.data.length}))}),l=this.suites.map(function(e){return g.sum(e.tests.map(function(e){return e.passed.filter(function(e){return!0===e}).length}))}),c=this.sum(u),h=this.suites.length,f=this.sum(l),p=this.sum(l.map(function(e,t){return e===u[t]?1:0})),m=f===c?"[32m":"[31m",d=p===h?"[32m":"[31m",console.log("API tests complete"),console.log(d+p+"[0m out of "+h+" suite"+this.plural(h)+" passed"),console.log(m+f+"[0m out of "+c+" test"+this.plural(c)+" passed"),console.log("\n"),f<c&&(console.log("\nFailed tests ([31m"+(c-f)+"[0m total): "),this.suites.forEach(function(e,t){l[t]<u[t]&&(console.log("\n[36m"+e.method.toUpperCase()+" "+e.path+"[0m"),e.tests.forEach(function(s,e){void 0!==s.passed.find(function(e){return!0!==e})&&console.log("[35m  "+s.description+"[0m"),s.passed.forEach(function(e,t){!1===e?console.log("[31m    FAILED[0m"+g.format_error(s.errors[t])):null===e&&console.log("[33m    INCONCLUSIVE[0m"+g.format_error(s.errors[t]))})}))}),console.log("\n"));case 53:case"end":return e.stop()}},e,this)})),function(){return e.apply(this,arguments)})},{key:"call",value:function(o,a,i){var u=this;return new Promise(function(s,e){i=Object.assign({},{body:null,params:null,query:null,token:""},i);var t=JSON.stringify(i.body);null!==i.params&&Object.keys(i.params).forEach(function(e){a=a.replace(":"+e,i.params[e])});var r={"Content-Type":"application/json;charset=UTF-8",Authorization:"Bearer "+i.token};"get"===o&&null!==i.query&&(a+="?"+Object.keys(i.query).map(function(e){return e+"="+i.query[e]}).join("&")),console.log("[36m ",a,"[0m"),"get"!==o&&(console.log("[2m ",i.body,"[0m"),r["Content-Length"]=Buffer.byteLength(t));var n=http.request({host:u.env.host,port:u.env.port,path:u.env.path_root+a,method:o,headers:r},function(e){var t="";e.on("data",function(e){t+=e}),e.on("end",function(){try{var e=JSON.parse(t);s(e)}catch(e){s({err:t,result:null})}})});"get"===o||n.write(t),n.end()})}},{key:"sum",value:function(e){return e.reduce(function(e,t){return e+t},0)}},{key:"plural",value:function(e){return 1===e?"":"s"}},{key:"format_error",value:function(e){return null!==e?" - "+(e||""):""}}]),t}(),Suite=function e(t,s,r){(0,_classCallCheck2.default)(this,e),this.method=t,this.path=s,this.tests=r()};function when(s){return{with:function(t){return{check:function(e){return{description:s,data_getter:t,data:null,checker:e,passed:null}}}}}}var MatchError=function(e){function t(e){return(0,_classCallCheck2.default)(this,t),(0,_possibleConstructorReturn2.default)(this,(0,_getPrototypeOf2.default)(t).call(this,e))}return(0,_inherits2.default)(t,e),t}((0,_wrapNativeSuper2.default)(Error));function isDateString(e){var t=new Date(e);return t instanceof Date&&!isNaN(t)}function match(a,i){if("object"!==(0,_typeof2.default)(a)||null===a)throw new TypeError("match() expects an object for its first argument. Instead received: "+String(a));if("object"!==(0,_typeof2.default)(i)||null===i)throw new TypeError("match() expects an object for its second argument. Instead received: "+String(i));return void 0===Object.keys(i).find(function(e){var t=void 0!==a[e],s=!1,r=!1;if(t){var n=i[e];!1===Array.isArray(n)&&(n=[n]),void 0!==n.find(function(e){return"?"===e[e.length-1]})&&(n=n.map(function(e){return"?"===e[e.length-1]?e.substring(0,e.length-1):e})).push("null");for(var o=0;o<n.length;o++){switch(n[o]){case"null":s=null===a[e];break;case"datestring":s=isDateString(a[e]);break;case"string":s="string"==typeof a[e];break;case"number":s="number"==typeof a[e];break;case"boolean":s="boolean"==typeof a[e];break;case"array":s=Array.isArray(a[e]);break;case"object":s="object"===(0,_typeof2.default)(a[e])&&null!==a[e];break;default:s=!(r=!0)}if(!0===s||!0===r)break}if(!0===r)throw new MatchError('"'+n+'" is not a valid type target');if(!1===s)throw new MatchError("match() expects "+e+' to be type "'+n+'". Instead received: '+String(a[e]))}return!t||!s})}var Mionendas={Tester:Tester,Suite:Suite,when:when,match:match};module.exports=Mionendas;