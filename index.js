"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_typeof2=_interopRequireDefault(require("@babel/runtime/helpers/typeof")),_possibleConstructorReturn2=_interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn")),_getPrototypeOf2=_interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf")),_inherits2=_interopRequireDefault(require("@babel/runtime/helpers/inherits")),_wrapNativeSuper2=_interopRequireDefault(require("@babel/runtime/helpers/wrapNativeSuper")),_regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),http=require("http"),Tester=function(){function t(e){(0,_classCallCheck2.default)(this,t),this.env=e,this.suites=[],this.storage={},this.declareSuites&&(this.suites=this.declareSuites())}var e;return(0,_createClass2.default)(t,[{key:"run",value:(e=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function e(){var t,s,r,n,a,i,o,u,l,c,h,p,f,m,d,g,b=this;return _regenerator.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:console.log("\n"),console.log("Starting API tests"),console.log("\n\n"),t=0;case 4:if(!(t<this.suites.length)){e.next=39;break}console.log("[36m"+this.suites[t].method.toUpperCase()+" "+this.suites[t].path+"[0m"),console.log("[2m"+this.suites[t].tests.length+" test"+this.plural(this.suites[t].tests.length)+" [0m"),console.log("\n"),s=0;case 9:if(!(s<this.suites[t].tests.length)){e.next=34;break}console.log("[35m"+this.suites[t].tests[s].description+"[0m"),console.log("- - - - - - - - - - - - - - - - - - -"),this.suites[t].tests[s].data=this.suites[t].tests[s].data_getter(),!1===Array.isArray(this.suites[t].tests[s].data)&&(this.suites[t].tests[s].data=[this.suites[t].tests[s].data]),this.suites[t].tests[s].passed=[],r=0;case 16:if(r<this.suites[t].tests[s].data.length)return e.next=19,this.call(this.suites[t].method,this.suites[t].path,this.suites[t].tests[s].data[r]);e.next=30;break;case 19:n=e.sent,a=void 0,a=n.err?(console.log(" ",n.err),n.err):(console.log(" ",n.result),n.result),o=i=null;try{i=this.suites[t].tests[s].checker(a,r)}catch(e){e instanceof MatchError&&(i=!1),o=e}u=null!==o?" - "+(o||""):"",!0===i?(this.suites[t].tests[s].passed[r]=!0,console.log("[32m  PASSED\n[0m")):!1===i?(this.suites[t].tests[s].passed[r]=!1,console.log("[31m  FAILED[0m"+u+"\n")):(this.suites[t].tests[s].passed[r]=null,console.log("[33m  INCONCLUSIVE[0m"+u+"\n"));case 27:r++,e.next=16;break;case 30:console.log("");case 31:s++,e.next=9;break;case 34:console.log("\n\n\n");case 36:t++,e.next=4;break;case 39:l=this.suites.map(function(e){return b.sum(e.tests.map(function(e){return e.data.length}))}),c=this.suites.map(function(e){return b.sum(e.tests.map(function(e){return e.passed.filter(function(e){return!0===e}).length}))}),h=this.sum(l),p=this.suites.length,f=this.sum(c),m=this.sum(c.map(function(e,t){return e===l[t]?1:0})),d=f===h?"[32m":"[31m",g=m===p?"[32m":"[31m",console.log("API tests complete"),console.log(g+m+"[0m out of "+p+" suite"+this.plural(p)+" passed"),console.log(d+f+"[0m out of "+h+" test"+this.plural(h)+" passed"),console.log("\n");case 52:case"end":return e.stop()}},e,this)})),function(){return e.apply(this,arguments)})},{key:"call",value:function(r,n,a){var i=this;return new Promise(function(s,e){null!==(a=Object.assign({},{body:null,params:null,query:null,token:""},a)).params&&Object.keys(a.params).forEach(function(e){n=n.replace(":"+e,a.params[e])}),"get"===r&&null!==a.query&&(n+="?"+Object.keys(a.query).map(function(e){return e+"="+a.query[e]}).join("&")),console.log("[36m ",n,"[0m"),"get"!==r&&console.log("[2m ",a.body,"[0m");var t=http.request({host:i.env.host,port:i.env.port,path:i.env.path_root+n,method:r,headers:{"Content-Type":"application/json;charset=UTF-8",Authorization:"Bearer "+a.token}},function(e){var t="";e.on("data",function(e){t+=e}),e.on("end",function(){try{var e=JSON.parse(t);s(e)}catch(e){s({err:t,result:null})}})});"get"===r||t.write(JSON.stringify(a.body)),t.end()})}},{key:"sum",value:function(e){return e.reduce(function(e,t){return e+t},0)}},{key:"plural",value:function(e){return 1===e?"":"s"}}]),t}(),Suite=function e(t,s,r){(0,_classCallCheck2.default)(this,e),this.method=t,this.path=s,this.tests=r()};function when(s){return{with:function(t){return{check:function(e){return{description:s,data_getter:t,data:null,checker:e,passed:null}}}}}}var MatchError=function(e){function t(e){return(0,_classCallCheck2.default)(this,t),(0,_possibleConstructorReturn2.default)(this,(0,_getPrototypeOf2.default)(t).call(this,e))}return(0,_inherits2.default)(t,e),t}((0,_wrapNativeSuper2.default)(Error));function isDateString(e){var t=new Date(e);return t instanceof Date&&!isNaN(t)}function match(a,i){if("object"!==(0,_typeof2.default)(a)||null===a)throw new TypeError("match() expects an object for its first argument. Instead received: "+String(a));if("object"!==(0,_typeof2.default)(i)||null===i)throw new TypeError("match() expects an object for its second argument. Instead received: "+String(i));return void 0===Object.keys(i).find(function(e){var t=void 0!==a[e],s=!1;if(t){var r=i[e];!1===Array.isArray(r)&&(r=[r]),void 0!==r.find(function(e){return"?"===e[e.length-1]})&&(r=r.map(function(e){return"?"===e[e.length-1]?e.substring(0,e.length-1):e})).push("null");for(var n=0;n<r.length;n++){switch(r[n]){case"null":s=null===a[e];break;case"datestring":s=isDateString(a[e]);break;case"string":s="string"==typeof a[e];break;case"number":s="number"==typeof a[e];break;case"boolean":s="boolean"==typeof a[e];break;case"array":s=Array.isArray(a[e]);break;case"object":s="object"===(0,_typeof2.default)(a[e])&&null!==a[e]}if(!0===s)break}if(!1===s)throw new MatchError("match() expects "+e+' to be type "'+r+'". Instead received: '+String(a[e]))}return!t||!s})}var Mionendas={Tester:Tester,Suite:Suite,when:when,match:match};module.exports=Mionendas;