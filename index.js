"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_typeof2=_interopRequireDefault(require("@babel/runtime/helpers/typeof")),_regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),http=require("http"),Tester=function(){function t(e){(0,_classCallCheck2.default)(this,t),this.env=e,this.suites=[],this.storage={},this.declareSuites&&(this.suites=this.declareSuites())}var e;return(0,_createClass2.default)(t,[{key:"run",value:(e=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function e(){var t,s,r,n,o,a,i,u,l,c,h,p,f;return _regenerator.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:console.log("\n"),console.log("Starting API tests"),console.log("\n\n"),t=0;case 4:if(!(t<this.suites.length)){e.next=29;break}console.log("[36m"+this.suites[t].method.toUpperCase()+" "+this.suites[t].path+"[0m"),console.log("[2m"+this.suites[t].tests.length+" tests[0m"),console.log("\n"),s=0;case 9:if(s<this.suites[t].tests.length)return console.log("[35m"+this.suites[t].tests[s].description+"[0m"),console.log("- - - - - - - - - - - - - - - - - - -"),e.next=14,this.call(this.suites[t].method,this.suites[t].path,this.suites[t].tests[s].data);e.next=24;break;case 14:r=e.sent,n=void 0,n=r.err?(console.log(" ",r.err),r.err):(console.log(" ",r.result),r.result),o=void 0;try{o=this.suites[t].tests[s].checker(n)}catch(e){o=!1}!0===o?(this.suites[t].tests[s].passed=!0,console.log("[32m  PASSED[0m")):!1===o?(this.suites[t].tests[s].passed=!1,console.log("[31m  FAILED[0m")):console.log("[33m  INCONCLUSIVE[0m"),console.log("\n");case 21:s++,e.next=9;break;case 24:console.log("\n");case 26:t++,e.next=4;break;case 29:a=this.suites.map(function(e){return e.tests.length}),i=this.suites.map(function(e){return e.tests.filter(function(e){return!0===e.passed}).length}),u=this.sum(a),l=this.suites.length,c=this.sum(i),h=this.sum(i.map(function(e,t){return e===a[t]?1:0})),p=c===u?"[32m":"[31m",f=h===l?"[32m":"[31m",console.log("API tests complete"),console.log(f+h+"[0m out of "+l+" suites passed"),console.log(p+c+"[0m out of "+u+" tests passed"),console.log("\n");case 42:case"end":return e.stop()}},e,this)})),function(){return e.apply(this,arguments)})},{key:"call",value:function(r,n,o){var a=this;return new Promise(function(s,e){null!==(o=Object.assign({},{body:null,params:null,query:null},o)).params&&Object.keys(o.params).forEach(function(e){n=n.replace(":"+e,o.params[e])}),"get"===r&&null!==o.query&&(n+="?"+Object.keys(o.query).map(function(e){return e+"="+o.query[e]}).join("&")),console.log("[36m ",n,"[0m"),"get"!==r&&console.log("[2m ",o.body,"[0m");var t=http.request({host:a.env.host,port:a.env.port,path:a.env.path_root+n,method:r,headers:{"Content-Type":"application/json;charset=UTF-8",Authorization:"Bearer "+a.storage.token}},function(e){var t="";e.on("data",function(e){t+=e}),e.on("end",function(){try{var e=JSON.parse(t);s(e)}catch(e){s({err:t,result:null})}})});"get"===r||t.write(JSON.stringify(o.body)),t.end()})}},{key:"sum",value:function(e){return e.reduce(function(e,t){return e+t},0)}}]),t}(),Suite=function e(t,s,r){(0,_classCallCheck2.default)(this,e),this.method=t,this.path=s,this.tests=r()};function when(s){return{with:function(t){return{check:function(e){return{description:s,data:t,checker:e,passed:null}}}}}}function match(r,n){return void 0===Object.keys(n).find(function(e){var t=void 0!==r[e],s=!1;if(t)switch(n[e]){case"string":s="string"==typeof r[e];break;case"number":s="number"==typeof r[e];break;case"boolean":s="boolean"==typeof r[e];break;case"array":s=Array.isArray(r[e]);break;case"object":s="object"===(0,_typeof2.default)(r[e])&&null!==r[e]}return!t||!s})}var Mionendas={Tester:Tester,Suite:Suite,when:when,match:match};module.exports=Mionendas;